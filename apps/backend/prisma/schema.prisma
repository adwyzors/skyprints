generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

///////////////////////////////
// USERS & PERMISSIONS
///////////////////////////////

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  name          String
  role          String   @default("OPERATOR")
  isActive      Boolean  @default(true)

  assignedRuns  ProcessRun[]
  createdOrders Order[]
  notifications Notification[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

///////////////////////////////
// CUSTOMERS
///////////////////////////////

model Customer {
  id           String  @id @default(uuid())
  code         String  @unique
  name         String
  email        String?
  phone        String?
  address      String?
  isActive     Boolean @default(true)

  orders       Order[]

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

///////////////////////////////
// WORKFLOW
///////////////////////////////

model WorkflowType {
  id          String   @id @default(uuid())
  code        String   @unique
  isActive    Boolean  @default(true)

  statuses    WorkflowStatus[]
  transitions WorkflowTransition[]
  auditLogs   WorkflowAuditLog[]

  // ðŸ‘‡ inverse relations (REQUIRED)
  processes      Process[]
  orderProcesses OrderProcess[]

  createdAt   DateTime @default(now())
}

model WorkflowStatus {
  id             String   @id @default(uuid())
  workflowTypeId String
  code           String
  isInitial      Boolean  @default(false)
  isTerminal     Boolean  @default(false)
  color          String?  @default("#6B7280")
  icon           String?

  workflowType WorkflowType @relation(fields: [workflowTypeId], references: [id])

  fromTransitions WorkflowTransition[] @relation("From")
  toTransitions   WorkflowTransition[] @relation("To")

  @@unique([workflowTypeId, code])
  createdAt DateTime @default(now())
}

model WorkflowTransition {
  id             String   @id @default(uuid())
  workflowTypeId String
  fromStatusId   String
  toStatusId     String
  condition      String?
  isParallel     Boolean  @default(false)

  workflowType WorkflowType   @relation(fields: [workflowTypeId], references: [id])
  fromStatus   WorkflowStatus @relation("From", fields: [fromStatusId], references: [id])
  toStatus     WorkflowStatus @relation("To", fields: [toStatusId], references: [id])

  @@unique([workflowTypeId, fromStatusId, toStatusId])
  createdAt DateTime @default(now())
}

///////////////////////////////
// ADMIN CONFIGURATION
///////////////////////////////

model Process {
  id             String @id @default(uuid())
  name           String
  description    String?
  isEnabled      Boolean @default(false)

  // ðŸ‘‡ process-specific lifecycle
  workflowTypeId String
  workflowType   WorkflowType @relation(fields: [workflowTypeId], references: [id])

  runDefs        ProcessRunDefinition[]
  orderProcesses OrderProcess[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model RunTemplate {
  id     String @id @default(uuid())
  name   String
  fields Json

  runDefs ProcessRunDefinition[]
  runs    ProcessRun[]

  createdAt DateTime @default(now())
}

model ProcessRunDefinition {
  id            String @id @default(uuid())
  processId     String
  runTemplateId String
  displayName   String
  sortOrder     Int

  process     Process     @relation(fields: [processId], references: [id])
  runTemplate RunTemplate @relation(fields: [runTemplateId], references: [id])

  @@unique([processId, sortOrder])
  createdAt DateTime @default(now())
}

///////////////////////////////
// ORDERS (RUNTIME)
///////////////////////////////

model Order {
  id           String @id @default(uuid())
  orderCode    String @unique
  customerId   String
  quantity     Int
  statusCode   String
  totalAmount  Decimal? @db.Decimal(10, 2)
  userId       String?

  customer     Customer @relation(fields: [customerId], references: [id])
  user         User?    @relation(fields: [userId], references: [id])

  processes    OrderProcess[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([statusCode])
  @@index([customerId])
  @@index([createdAt])
}

model OrderProcess {
  id             String @id @default(uuid())

  orderId        String
  processId      String

  // ðŸ‘‡ copied from Process at runtime
  workflowTypeId String
  workflowType   WorkflowType @relation(fields: [workflowTypeId], references: [id])

  statusCode     String
  progress       Int @default(0)
  minRuns        Int @default(1)
  maxRuns        Int @default(1)

  // ðŸ‘‡ explicit relations (fixes all Prisma errors)
  order          Order   @relation(fields: [orderId], references: [id])
  process        Process @relation(fields: [processId], references: [id])

  runs           ProcessRun[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([orderId, processId])
}

model ProcessRun {
  id             String @id @default(uuid())
  orderProcessId String
  displayName    String
  runTemplateId  String
  runNumber      Int
  statusCode     String
  statusVersion  Int      @default(0)

  fields         Json

  locationId     String?
  location       Location? @relation(fields: [locationId], references: [id])

  assignedToId   String?
  assignedTo     User? @relation(fields: [assignedToId], references: [id])

  startedAt      DateTime?
  completedAt    DateTime?

  orderProcess OrderProcess @relation(fields: [orderProcessId], references: [id])
  runTemplate  RunTemplate  @relation(fields: [runTemplateId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([orderProcessId, runNumber])
  @@index([statusCode])
  @@index([assignedToId])
  @@index([locationId])
}

///////////////////////////////
// LOCATIONS
///////////////////////////////

model Location {
  id          String  @id @default(uuid())
  code        String  @unique
  name        String
  description String?
  type        String  @default("WORKSTATION")
  isActive    Boolean @default(true)

  runs        ProcessRun[]

  createdAt   DateTime @default(now())
}

///////////////////////////////
// OUTBOX
///////////////////////////////

model OutboxEvent {
  id            String   @id @default(uuid())
  aggregateType String
  aggregateId   String
  eventType     String
  payload       Json
  processed     Boolean  @default(false)
  retryCount    Int      @default(0)
  error         String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([processed, createdAt])
}

///////////////////////////////
// AUDIT LOGS
///////////////////////////////

model WorkflowAuditLog {
  id             String   @id @default(uuid())
  workflowTypeId String
  aggregateType  String
  aggregateId    String
  fromStatus     String?
  toStatus       String
  transitionId   String?
  userId         String?
  payload        Json?

  workflowType WorkflowType @relation(fields: [workflowTypeId], references: [id])

  createdAt DateTime @default(now())

  @@index([aggregateId, createdAt])
  @@index([workflowTypeId])
  @@index([userId])
}

///////////////////////////////
// NOTIFICATIONS
///////////////////////////////

model Notification {
  id          String   @id @default(uuid())
  userId      String
  type        String
  title       String
  message     String
  isRead      Boolean  @default(false)
  metadata    Json?

  user        User @relation(fields: [userId], references: [id])

  createdAt   DateTime @default(now())
  readAt      DateTime?

  @@index([userId, isRead, createdAt])
}
