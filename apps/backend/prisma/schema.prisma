generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

///////////////////////////////
// USERS & PERMISSIONS
///////////////////////////////

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  name          String
  role          String   @default("OPERATOR")
  isActive      Boolean  @default(true)

  assignedRuns  ProcessRun[]
  createdOrders Order[]
  notifications Notification[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

///////////////////////////////
// CUSTOMERS
///////////////////////////////

model Customer {
  id        String  @id @default(uuid())
  code      String  @unique
  name      String
  email     String?
  phone     String?
  address   String?
  isActive  Boolean @default(true)

  orders    Order[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

///////////////////////////////
// WORKFLOW
///////////////////////////////

model WorkflowType {
  id       String @id @default(uuid())
  code     String @unique
  isActive Boolean @default(true)

  statuses    WorkflowStatus[]
  transitions WorkflowTransition[]
  auditLogs   WorkflowAuditLog[]

  configRunTemplates    RunTemplate[] @relation("ConfigWF")
  lifecycleRunTemplates RunTemplate[] @relation("LifecycleWF")

  createdAt DateTime @default(now())
}

model WorkflowStatus {
  id             String @id @default(uuid())
  workflowTypeId String
  code           String
  isInitial      Boolean @default(false)
  isTerminal     Boolean @default(false)

  workflowType WorkflowType @relation(fields: [workflowTypeId], references: [id])

  fromTransitions WorkflowTransition[] @relation("From")
  toTransitions   WorkflowTransition[] @relation("To")

  createdAt DateTime @default(now())

  @@unique([workflowTypeId, code])
}

model WorkflowTransition {
  id             String @id @default(uuid())
  workflowTypeId String
  fromStatusId   String
  toStatusId     String
  condition      String?

  workflowType WorkflowType   @relation(fields: [workflowTypeId], references: [id])
  fromStatus   WorkflowStatus @relation("From", fields: [fromStatusId], references: [id])
  toStatus     WorkflowStatus @relation("To", fields: [toStatusId], references: [id])

  @@unique([workflowTypeId, fromStatusId, toStatusId])
}

//////////////////////////////
// RUN TEMPLATE
//////////////////////////////

model RunTemplate {
  id     String @id @default(uuid())
  name   String
  fields Json

  configWorkflowTypeId    String
  lifecycleWorkflowTypeId String

  configWorkflowType    WorkflowType @relation("ConfigWF", fields: [configWorkflowTypeId], references: [id])
  lifecycleWorkflowType WorkflowType @relation("LifecycleWF", fields: [lifecycleWorkflowTypeId], references: [id])

  runDefs ProcessRunDefinition[]
  runs    ProcessRun[]

  createdAt DateTime @default(now())
}

//////////////////////////////
// PROCESS CONFIG
//////////////////////////////

model Process {
  id          String @id @default(uuid())
  name        String
  description String?

  isEnabled   Boolean @default(false)

  runDefs        ProcessRunDefinition[]
  orderProcesses OrderProcess[]

  createdAt DateTime @default(now())
}

model ProcessRunDefinition {
  id            String @id @default(uuid())
  processId     String
  runTemplateId String
  displayName   String
  sortOrder     Int

  process     Process     @relation(fields: [processId], references: [id])
  runTemplate RunTemplate @relation(fields: [runTemplateId], references: [id])

  @@unique([processId, sortOrder])
}

//////////////////////////////
// ORDERS (RUNTIME)
//////////////////////////////

model Order {
  id         String @id @default(uuid())
  customerId String
  quantity   Int

  workflowTypeId String
  statusCode     String

  createdById String
  createdBy   User     @relation(fields: [createdById], references: [id])
  customer    Customer @relation(fields: [customerId], references: [id])

  processes OrderProcess[]

  createdAt DateTime @default(now())
}

model OrderProcess {
  id        String @id @default(uuid())
  orderId   String
  processId String

  workflowTypeId String
  statusCode     String

  order   Order   @relation(fields: [orderId], references: [id])
  process Process @relation(fields: [processId], references: [id])

  runs ProcessRun[]

  @@unique([orderId, processId])
}

model ProcessRun {
  id             String @id @default(uuid())
  orderProcessId String
  runTemplateId  String
  runNumber      Int
  displayName    String

  configWorkflowTypeId    String
  lifecycleWorkflowTypeId String

  statusCode          String
  lifeCycleStatusCode String

  fields Json

  assignedUserId String?
  locationId     String?

  assignedUser User?     @relation(fields: [assignedUserId], references: [id])
  location     Location? @relation(fields: [locationId], references: [id])

  orderProcess OrderProcess @relation(fields: [orderProcessId], references: [id])
  runTemplate  RunTemplate  @relation(fields: [runTemplateId], references: [id])

  @@unique([orderProcessId, runNumber])
}

///////////////////////////////
// LOCATIONS
///////////////////////////////

model Location {
  id          String  @id @default(uuid())
  code        String  @unique
  name        String
  description String?
  type        String  @default("WORKSTATION")
  isActive    Boolean @default(true)

  runs        ProcessRun[]

  createdAt   DateTime @default(now())
}

//////////////////////////////
// OUTBOX & AUDIT
//////////////////////////////

model OutboxEvent {
  id            String @id @default(uuid())
  aggregateType String
  aggregateId   String
  eventType     String
  payload       Json
  processed     Boolean @default(false)

  createdAt DateTime @default(now())
}

model WorkflowAuditLog {
  id             String @id @default(uuid())
  workflowTypeId String
  aggregateType  String
  aggregateId    String
  fromStatus     String?
  toStatus       String

  workflowType WorkflowType @relation(fields: [workflowTypeId], references: [id])

  createdAt DateTime @default(now())
}

///////////////////////////////
// NOTIFICATIONS
///////////////////////////////

model Notification {
  id        String   @id @default(uuid())
  userId    String
  type      String
  title     String
  message   String
  isRead    Boolean  @default(false)
  metadata  Json?

  user      User @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
  readAt    DateTime?

  @@index([userId, isRead, createdAt])
}
