generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}


///////////////////////////////
// WORKFLOW
///////////////////////////////

model WorkflowType {
  id          String   @id @default(uuid())
  code        String   @unique
  isActive    Boolean  @default(true)

  statuses    WorkflowStatus[]
  transitions WorkflowTransition[]

  auditLogs   WorkflowAuditLog[]
}

model WorkflowStatus {
  id             String   @id @default(uuid())
  workflowTypeId String
  code           String
  isInitial      Boolean  @default(false)
  isTerminal     Boolean  @default(false)

  workflowType WorkflowType @relation(fields: [workflowTypeId], references: [id])

  fromTransitions WorkflowTransition[] @relation("From")
  toTransitions   WorkflowTransition[] @relation("To")

  @@unique([workflowTypeId, code])
}

model WorkflowTransition {
  id             String   @id @default(uuid())
  workflowTypeId String
  fromStatusId   String
  toStatusId     String
  condition      String?

  workflowType WorkflowType   @relation(fields: [workflowTypeId], references: [id])
  fromStatus   WorkflowStatus @relation("From", fields: [fromStatusId], references: [id])
  toStatus     WorkflowStatus @relation("To", fields: [toStatusId], references: [id])

  @@unique([workflowTypeId, fromStatusId, toStatusId])
}

///////////////////////////////
// ADMIN CONFIGURATION
///////////////////////////////

model Process {
  id          String  @id @default(uuid())
  name        String
  description String?
  isEnabled   Boolean @default(false)

  runDefs        ProcessRunDefinition[]
  orderProcesses OrderProcess[]

  createdAt DateTime @default(now())
}

model RunTemplate {
  id     String @id @default(uuid())
  name   String
  fields Json

  runDefs ProcessRunDefinition[]
  runs    ProcessRun[]
}

model ProcessRunDefinition {
  id            String @id @default(uuid())
  processId     String
  runTemplateId String
  displayName   String
  sortOrder     Int

  process     Process     @relation(fields: [processId], references: [id])
  runTemplate RunTemplate @relation(fields: [runTemplateId], references: [id])

  @@unique([processId, sortOrder])
}

///////////////////////////////
// ORDERS (RUNTIME)
///////////////////////////////

model Order {
  id           String @id @default(uuid())
  orderCode    String @unique
  customerName String
  quantity     Int
  statusCode   String

  processes OrderProcess[]

  createdAt DateTime @default(now())

  @@index([statusCode])
}

model OrderProcess {
  id         String @id @default(uuid())
  orderId    String
  processId  String
  statusCode String

  order   Order   @relation(fields: [orderId], references: [id])
  process Process @relation(fields: [processId], references: [id])
  runs    ProcessRun[]

  createdAt DateTime @default(now())

  @@unique([orderId, processId])
  @@index([statusCode])
}

model ProcessRun {
  id             String @id @default(uuid())
  orderProcessId String
  displayName    String
  runTemplateId  String
  runNumber      Int
  statusCode     String
  statusVersion  Int      @default(0) //optimistic lock

  fields         Json
  location       String?

  orderProcess OrderProcess @relation(fields: [orderProcessId], references: [id])
  runTemplate  RunTemplate  @relation(fields: [runTemplateId], references: [id])

  createdAt DateTime @default(now())

  @@unique([orderProcessId, runNumber])
  @@index([statusCode])
}

///////////////////////////////
// OUTBOX
///////////////////////////////

model OutboxEvent {
  id            String   @id @default(uuid())
  aggregateType String
  aggregateId   String
  eventType     String
  payload       Json
  processed     Boolean  @default(false)
  createdAt     DateTime @default(now())

  @@index([processed, createdAt])
}

model WorkflowAuditLog {
  id             String   @id @default(uuid())
  workflowTypeId String
  aggregateType  String
  aggregateId    String
  fromStatus     String?
  toStatus       String
  transitionId   String?
  payload        Json?
  createdAt      DateTime @default(now())

  workflowType WorkflowType @relation(fields: [workflowTypeId], references: [id])

  @@index([aggregateId, createdAt])
}
