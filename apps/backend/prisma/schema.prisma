generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

///////////////////////////////
// USERS & PERMISSIONS
///////////////////////////////

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  name          String
  isActive      Boolean  @default(true)

  createdOrders Order[]

  locationId String?   
  location   Location? @relation(fields: [locationId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?
  role      String

  executedProcessRuns ProcessRun[] @relation("ProcessRunExecutor")
  reviewedProcessRuns ProcessRun[] @relation("ProcessRunReviewer")

  @@index([locationId])
  @@index([email])
  @@index([role, isActive, deletedAt])
  @@index([name, isActive, deletedAt])
}


///////////////////////////////
// CUSTOMERS
///////////////////////////////

model Customer {
  id        String  @id @default(uuid())
  code      String  @unique
  name      String
  email     String?
  phone     String?
  address   String?
  isActive  Boolean @default(true)

  orders    Order[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  gstno String?
  tdsno Int?
  tds Boolean @default(false)
  tax Boolean @default(false)

  @@index([isActive])
  @@index([deletedAt])
  @@index([isActive, deletedAt])
  @@index([isActive, name, createdAt, deletedAt])
}

///////////////////////////////
// ORDER SEQUENCE
///////////////////////////////

model FiscalSequence {
  id         String   @id @default(uuid())
  prefix     String   // ORD | R
  fiscalYear String   // 25-26

  nextValue  Int
  updatedAt  DateTime @updatedAt

  @@unique([prefix, fiscalYear])
  @@index([prefix, fiscalYear])
}



///////////////////////////////
// WORKFLOW
///////////////////////////////

model WorkflowType {
  id       String @id @default(uuid())
  code     String @unique
  isActive Boolean @default(true)

  statuses    WorkflowStatus[]
  transitions WorkflowTransition[]

  configRunTemplates    RunTemplate[] @relation("ConfigWF")
  lifecycleRunTemplates RunTemplate[] @relation("LifecycleWF")

  createdAt DateTime @default(now())

  @@index([isActive])
}

model WorkflowStatus {
  id             String @id @default(uuid())
  workflowTypeId String
  code           String
  isInitial      Boolean @default(false)
  isTerminal     Boolean @default(false)

  workflowType WorkflowType @relation(fields: [workflowTypeId], references: [id])

  fromTransitions WorkflowTransition[] @relation("From")
  toTransitions   WorkflowTransition[] @relation("To")

  createdAt DateTime @default(now())

  @@unique([workflowTypeId, code])
  @@index([workflowTypeId, code])
  @@index([workflowTypeId, createdAt])
  @@index([workflowTypeId, isInitial])
  @@index([workflowTypeId, isTerminal])
}

model WorkflowTransition {
  id             String @id @default(uuid())
  workflowTypeId String
  fromStatusId   String
  toStatusId     String
  condition      String?

  workflowType WorkflowType   @relation(fields: [workflowTypeId], references: [id])
  fromStatus   WorkflowStatus @relation("From", fields: [fromStatusId], references: [id])
  toStatus     WorkflowStatus @relation("To", fields: [toStatusId], references: [id])

  @@unique([workflowTypeId, fromStatusId, toStatusId])
  @@index([workflowTypeId])
  @@index([fromStatusId])
  @@index([toStatusId])
  @@index([fromStatusId, toStatusId])
}

//////////////////////////////
// RUN TEMPLATE
//////////////////////////////

model RunTemplate {
  id     String @id @default(uuid())
  name   String
  fields Json

  billingFormula String?

  configWorkflowTypeId    String
  lifecycleWorkflowTypeId String

  configWorkflowType    WorkflowType @relation("ConfigWF", fields: [configWorkflowTypeId], references: [id])
  lifecycleWorkflowType WorkflowType @relation("LifecycleWF", fields: [lifecycleWorkflowTypeId], references: [id])

  runDefs ProcessRunDefinition[]
  runs    ProcessRun[]

  createdAt DateTime @default(now())

  @@index([configWorkflowTypeId])
  @@index([lifecycleWorkflowTypeId])
}

//////////////////////////////
// PROCESS CONFIG
//////////////////////////////

model Process {
  id          String @id @default(uuid())
  name        String
  description String?

  isEnabled   Boolean @default(false)

  runDefs        ProcessRunDefinition[]
  orderProcesses OrderProcess[]

  createdAt DateTime @default(now())

  @@index([isEnabled])
}

model ProcessRunDefinition {
  id            String @id @default(uuid())
  processId     String
  runTemplateId String
  displayName   String
  sortOrder     Int

  process     Process     @relation(fields: [processId], references: [id])
  runTemplate RunTemplate @relation(fields: [runTemplateId], references: [id])

  @@unique([processId, sortOrder])
  @@index([runTemplateId])
}

///////////////////////////////
// ORDERS
///////////////////////////////

enum OrderStatus {
    CONFIGURE 
    PRODUCTION_READY
    IN_PRODUCTION 
    COMPLETE 
    BILLED 
    GROUP_BILLED 
}

enum OrderProcessStatus {
    CONFIGURE 
    IN_PROGRESS 
    COMPLETE 
}


enum ProcessRunStatus {
    CONFIGURE 
    IN_PROGRESS 
    COMPLETE 
}


model Order {
  id         String @id @default(uuid())
  code       String
  deletedAt  DateTime?

  customerId String
  quantity   Int

  statusCode OrderStatus
  jobCode    String?
  images     String[] @default([])
  useOrderImageForRuns Boolean @default(false)
  
  createdById String
  createdBy   User     @relation(fields: [createdById], references: [id])
  customer    Customer @relation(fields: [customerId], references: [id])

  totalProcesses     Int @default(0)
  completedProcesses Int @default(0)

  processes OrderProcess[]
  billingContexts BillingContextOrder[]

  createdAt DateTime @default(now())
  lifecycleStartedAt DateTime?

  @@unique([code, deletedAt])

  @@index([id, deletedAt])
  @@index([deletedAt, createdAt(sort: Desc)])
  @@index([deletedAt, statusCode])
  @@index([deletedAt, customerId, createdAt(sort: Desc)])
  @@index([deletedAt, statusCode, createdAt(sort: Desc)])
  @@index([deletedAt, createdById])
}

///////////////////////////////
// ORDER PROCESS
///////////////////////////////

model OrderProcess {
  id        String @id @default(uuid())
  orderId   String
  processId String

  statusCode     OrderProcessStatus

  totalRuns              Int       @default(0)
  configCompletedRuns    Int       @default(0)
  lifecycleCompletedRuns Int       @default(0)

  configCompletedAt      DateTime?
  lifecycleCompletedAt   DateTime?

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  process Process @relation(fields: [processId], references: [id])

  runs ProcessRun[]

  remainingRuns Int @default(0)


  @@unique([orderId, processId])
  @@index([lifecycleCompletedRuns, totalRuns])
  @@index([remainingRuns])
}


///////////////////////////////
// PROCESS RUN
///////////////////////////////

model ProcessRun {
  id             String @id @default(uuid())
  orderProcessId String
  runTemplateId  String
  runNumber      Int
  displayName    String

  configWorkflowTypeId    String
  lifecycleWorkflowTypeId String

  statusCode          ProcessRunStatus
  lifeCycleStatusCode String

  fields Json

  executorId String?
  reviewerId String?
  locationId String?

  executor User? @relation("ProcessRunExecutor", fields: [executorId], references: [id])
  reviewer User? @relation("ProcessRunReviewer", fields: [reviewerId], references: [id])

  location Location? @relation(fields: [locationId], references: [id])

  orderProcess OrderProcess @relation(fields: [orderProcessId], references: [id], onDelete: Cascade)
  runTemplate  RunTemplate  @relation(fields: [runTemplateId], references: [id])
  createdAt DateTime @default(now())
  configuredAt   DateTime?


  @@unique([orderProcessId, runNumber])
  @@index([orderProcessId, id])
  @@index([orderProcessId, lifeCycleStatusCode])
  @@index([createdAt])
}


///////////////////////////////
// LOCATIONS
///////////////////////////////

model Location {
  id          String  @id @default(uuid())
  code        String  @unique
  name        String
  description String?
  type        String  @default("WORKSTATION")
  isActive    Boolean @default(true)

  users User[]

  runs ProcessRun[]

  createdAt DateTime @default(now())

  @@index([isActive])
}


///////////////////////////////
// BILLING
///////////////////////////////
enum BillingContextType {
  ORDER
  GROUP
}

enum BillingSnapshotIntent {
  DRAFT
  FINAL
}

enum CalculationType {
  INITIAL
  RECALCULATED
}

model BillingContext {
  id            String   @id @default(uuid())
  type          BillingContextType
  name          String
  description   String?

  orders        BillingContextOrder[]
  snapshots     BillingSnapshot[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([type])
  @@index([id])
}

model BillingContextOrder {
  id               String @id @default(uuid())
  billingContextId String
  orderId          String

  billingContext BillingContext @relation(fields: [billingContextId], references: [id])

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)


  createdAt DateTime @default(now())

  @@unique([billingContextId, orderId])
}

model BillingSnapshot {
  id               String   @id @default(uuid())

  billingContextId String
  version          Int
  isLatest         Boolean  @default(true)

  intent           BillingSnapshotIntent

  inputs           Json
  result           Decimal  @db.Decimal(18, 4)
  currency         String   @default("INR")

  calculationType  CalculationType
  reason           String?

  createdBy        String?
  createdAt        DateTime @default(now())

  billingContext BillingContext @relation(fields: [billingContextId], references: [id])

  @@unique([billingContextId, version])
  @@index([billingContextId, isLatest])
  @@index([billingContextId, intent, isLatest])
  @@index([billingContextId, version])
  @@index([intent])
}

///////////////////////////////
// ANALYTICS (PROJECTIONS)
///////////////////////////////

model DailyAnalytics {
  id          String   @id @default(uuid())
  date        DateTime @unique // Day level truncation
  
  totalRevenue Decimal @default(0) @db.Decimal(18, 4)
  totalOrders   Int     @default(0)
  totalUnits    Int     @default(0)
  
  billedRevenue Decimal @default(0) @db.Decimal(18, 4)
  billedOrders  Int     @default(0)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([date])
}

model ProcessAnalytics {
  id          String   @id @default(uuid())
  processId   String
  processName String
  
  totalRevenue Decimal @default(0) @db.Decimal(18, 4)
  totalRuns     Int     @default(0)
  totalUnits    Int     @default(0)
  
  avgLeadTime   Float   @default(0) // In hours
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([processId])
  @@index([processId])
}

model UserPerformance {
  id          String   @id @default(uuid())
  userId      String   @unique
  userName    String
  role        String
  
  runsExecuted Int     @default(0)
  runsReviewed Int     @default(0)
  
  totalBilledVolume Decimal @default(0) @db.Decimal(18, 4)
  
  lastActiveAt DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([userId])
  @@index([role])
}

model OrderAnalytics {
  id          String   @id @default(uuid())
  orderId     String   @unique
  orderCode   String
  
  customerId  String
  customerName String
  
  totalAmount  Decimal @default(0) @db.Decimal(18, 4)
  totalUnits   Int
  
  cycleTimeHours Float? // Time from creation to billed
  
  status       String
  billedAt     DateTime?
  
  createdAt    DateTime @default(now())

  @@index([orderId])
  @@index([customerId])
  @@index([status])
}

model LocationAnalytics {
  id            String   @id @default(uuid())
  locationId    String   @unique
  locationName  String
  
  totalRevenue  Decimal @default(0) @db.Decimal(18, 4)
  totalRuns      Int     @default(0)
  totalUnits     Int     @default(0)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([locationId])
}
